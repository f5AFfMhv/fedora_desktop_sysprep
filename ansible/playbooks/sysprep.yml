- name: Provision Fedora Desktop
  gather_facts: true
  hosts: localhost
  tasks:
    - name: Add repositories
      ansible.builtin.yum_repository:
        name: "{{ item.name }}"
        description: "{{ item.desc }}"
        baseurl: "{{ item.url }}"
        gpgkey: "{{ item.gpgkey }}"
        file: my_repos
        gpgcheck: true
        enabled: true
      with_items: "{{ enable_repositories }}"
      tags:
        - repo
        - install

    - name: Disable repositories
      ansible.builtin.yum_repository:
        name: "{{ item.name }}"
        description: "{{ item.desc }}"
        baseurl: "{{ item.url }}"
        file: "{{ item.file }}"
        enabled: false
      with_items: "{{ disable_repositories }}"
      tags:
        - repo
        - install

    - name: Update system
      ansible.builtin.dnf:
        name: "*"
        state: latest
      tags:
        - install

    - name: Remove bloat
      ansible.builtin.dnf:
        name: "{{ bloat }}"
        state: absent
        autoremove: true
      tags:
        - bloat
        - install

    - name: Install rpm packages
      ansible.builtin.dnf:
        name: "{{ rpms }}"
        state: present
      tags:
        - install

    - name: Add flathub repository
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
      tags:
        - flatpak
        - install

    - name: Remove filtered option from flathub repository
      ansible.builtin.command:
        cmd: flatpak remote-modify flathub --no-filter
      register: output
      changed_when: output.rc == 0
      tags:
        - flatpak
        - install

    - name: Install flatpak packages
      community.general.flatpak:
        name: "{{ flatpaks }}"
        state: present
      tags:
        - flatpak
        - install

    - name: Install python packages
      ansible.builtin.pip:
        name: "{{ python_packages }}"
      tags:
        - python
        - install

    - name: Add sudo rules
      community.general.sudoers:
        name: "{{ user }}-sudo-rules"
        state: present
        user: "{{ user }}"
        nopassword: true
        commands: "{{ allow_sudo }}"
      tags:
        - config

    - name: Create a symbolic links
      ansible.builtin.file:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ user }}"
        group: "{{ user }}"
        state: link
      with_items: "{{ symlinks }}"
      tags:
        - config

    - name: Enable/disable services
      ansible.builtin.service:
        name: "{{ item.name }}"
        state: "{{ item.state }}"
        enabled: "{{ item.enabled }}"
      with_items: "{{ services }}"
      tags:
        - config

    - name: Add DNS configuration
      ansible.builtin.template:
        src: resolv.conf.j2
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: "0644"
      tags:
        - config

    - name: Create cron jobs
      ansible.builtin.cron:
        name: "{{ item.name }}"
        special_time: reboot
        user: "{{ user }}"
        job: "{{ item.job }}"
      with_items: "{{ cron_jobs }}"
      tags:
        - config
